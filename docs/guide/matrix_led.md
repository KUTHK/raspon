# 行列LEDの制御

冒頭: 少ないピンで多くのLEDを扱うための基本手法を身につける。

## 簡単（初心者向け）

- 行を1本ずつ有効化し、同時に列のパターンを出力して高速に切替（残像で面表示）。
- 1行の点灯時間を短くし、全行を十分な周波数（おおむね100Hz以上）で巡回するとチラつきが減る。

```asm
  @ 行iを有効、列パターンを出力 → 少し待つ → 次の行へ
  bl set_row_i
  bl output_columns_for_i
  bl tiny_delay
```

まとめ: 「行を順に選ぶ＋列にパターン」を高速に繰り返すだけ。

## 普通（上級者向け）

### 配線と極性

- 行・列の極性（アクティブH/L）は配線で決まる。実機の配線図に合わせて「有効＝1/0」を一致させること。
- 列に電流制限抵抗を必ず入れる。行側は合成電流が流れるため、最大電流に注意。

### スキャン周波数と残像・輝度

- 行数を N、1行あたりの点灯（滞在）時間を t_row とすると、全体のリフレッシュ周波数 f ≈ 1 / (N × t_row)。
- チラつきを抑えるには f を 100–200Hz 以上に。例：N=8, 目標 f=200Hz → t_row ≈ 1 / (8×200) ≈ 0.625ms。
- 行スキャンでは各LEDのデューティが 1/N まで下がる。輝度が不足する場合は瞬時電流（安全範囲内）、またはPWM併用で視覚的な輝度を確保。

### ゴースト防止の順序

- 次の順に切り替えるとゴーストを抑えやすい。
  1) 列を全消灯（安全な無効パターン）
  2) 現在の行を無効化
  3) 次行の列パターンをセット（ラッチ）
  4) 次の行を有効化
  5) 必要なら列を有効パターンへ復帰

### データ表現と回転

- ビットマップを「行配列 × 列ビット」で持つと扱いやすい。表示の90°回転やスクロールは、インデックス変換やビット回転で実装。
- `display/rotate.s` のように、表示座標→物理行列（行/列/極性）への射影を1カ所に集約すると保守性が良い。

### タイミングの安定化

- busy-wait の微小ディレイはCPU速度に依存する。タイマ（システムタイマまたは簡易カウンタ）を基準に待つと安定。
- 行切替の直前直後で列を書き換える場合は、必要に応じてメモリバリア（I/O順序）を検討。

```asm
  @ 行スキャンの安全な骨格（概念）
scan_one_row:
  bl columns_all_off     @ 1) 列を無効
  bl disable_row_curr    @ 2) 現行行を無効
  bl load_next_row_data  @ 3) 次行データを列へセット
  bl enable_row_next     @ 4) 次行を有効
  bl dwell_us            @ 5) 滞在時間
  bx lr
```

まとめ: 周波数設計（t_row と N）、切替順序（ゴースト防止）、データ表現（極性・回転）を揃えると安定・高輝度で表示できる。
