# 行列LEDの制御

- マトリックスLEDは、複数のLEDを行(row)と列(column)で構成された格子状に配置した表示装置です。
- 各LEDは、特定の行と列の交点に配置されており、行と列の制御によって個別に点灯・消灯が可能です。
- この構造により、少ない制御ピンで多くのLEDを制御でき、文字や図形などの表示が効率的に行えます。
- 主な用途には、ディスプレイ、インジケータ、情報表示パネルなどがあります。


## 簡単（初心者向け）

- 行を1本ずつ有効化し、同時に列のパターンを出力して高速に切替（残像で面表示）。
- 1行の点灯時間を短くし、全行を十分な周波数（おおむね100Hz以上）で巡回するとチラつきが減る。

```asm
  @ 行iを有効、列パターンを出力 → 少し待つ → 次の行へ
  bl set_row_i
  bl output_columns_for_i
  bl tiny_delay
```

まとめ: 「行を順に選ぶ＋列にパターン」を高速に繰り返すだけ。

## 普通（上級者向け）

### ゴースト防止の順序

- 次の順に切り替えるとゴーストを抑えやすい。
  1) 列を全消灯（安全な無効パターン）
  2) 現在の行を無効化
  3) 次行の列パターンをセット（ラッチ）
  4) 次の行を有効化
  5) 必要なら列を有効パターンへ復帰

### データ表現と回転

- ビットマップを「行配列 × 列ビット」で持つと扱いやすい。表示の90°回転やスクロールは、インデックス変換やビット回転で実装。
- `display/rotate.s` のように、表示座標→物理行列（行/列/極性）への射影を1カ所に集約すると保守性が良い。

### タイミングの安定化

- busy-wait の微小ディレイはCPU速度に依存する。タイマ（システムタイマまたは簡易カウンタ）を基準に待つと安定。
- 行切替の直前直後で列を書き換える場合は、必要に応じてメモリバリア（I/O順序）を検討。

```asm
  @ 行スキャンの安全な骨格（概念）
scan_one_row:
  bl columns_all_off     @ 1) 列を無効
  bl disable_row_curr    @ 2) 現行行を無効
  bl load_next_row_data  @ 3) 次行データを列へセット
  bl enable_row_next     @ 4) 次行を有効
  bl dwell_us            @ 5) 滞在時間
  bx lr
```

まとめ: 周波数設計（t_row と N）、切替順序（ゴースト防止）、データ表現（極性・回転）を揃えると安定・高輝度で表示できる。
