# スピーカー制御

冒頭: 可聴周波のON/OFF制御で音階を作る。PWMやトグル出力で実現できる。

## 簡単（初心者向け）

- A4=440Hz を基準に半音ごとに周波数が 2^(1/12) 倍。PWMの周期設定で周波数を決める。

## 簡単な音出し（概念）

```asm
  @ PWM2のRNG/DATを周波数に合わせて更新
  bl pwm_set_freq_and_duty
```

まとめ: 周波数は周期、音量はデューティ。パラメータで楽曲を作れる。

## 普通（上級者向け）

### PWMクロックと分周

- Clock Manager の `CM_PWMCTL`/`CM_PWMDIV` で PWM クロックを設定。`PWMDIV` は整数部と小数部（12.12固定小数）。
- 本リポジトリでは便宜上 `PWM_HZ ≒ 9.6MHz` を前提として周波数計算を行う。

### 周期とデューティの設計

- Mark-Space モード（`MSEN2=1`）では、周波数 f ≒ PWM_clk / RNG。占有率は DAT/RNG。
- 例：A4（440Hz）を鳴らすとき、RNG ≒ PWM_clk / 440。
  - PWM_clk=9.6MHz → RNG ≒ 21818（近い整数へ丸める）。
  - 音量50%なら DAT ≒ RNG/2。

### 音階テーブル

- 半音ステップ n に対し f(n) = 440 × 2^(n/12)。
- 実装では浮動小数を避け、固定小数で前計算したテーブルを持つと高速・簡便。

### 波形品質とフィルタ

- 単純PWMは矩形波。スピーカーの機械特性である程度丸まるが、高域ノイズが気になる場合はRCフィルタやデューティ／周波数の最適化を検討。

まとめ: PWMクロック→RNGで周波数、DATで音量。固定小数のテーブル化でリアルタイム負荷を抑えると安定する。
